
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="format-detection" content="telephone=no" />
<title>Relational‚ÄëSpatial Dual N‚ÄëBack + Voice N‚ÄëMatch</title>
<style>
  /* ===== Base ===== */
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;padding:24px;background:#f8fafc;color:#0f172a;
       font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,system-ui,sans-serif}
  .container{max-width:1180px;margin:0 auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 18px 36px -20px rgba(2,6,23,.25);padding:18px}

  .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:16px}
  .title{display:flex;align-items:center;gap:10px}
  .title h1{margin:0;font-size:28px;letter-spacing:.2px}
  .header-right{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .score-display{font-size:13px;font-weight:600}
  .settings-display{font-size:13px;color:#475569;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  .hidden{display:none!important}

  /* ===== Buttons ===== */
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:10px;padding:10px 16px;cursor:pointer;
       font-weight:700;transition:.18s}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn-primary{background:#2563eb;color:#fff}.btn-primary:hover{background:#1d4ed8}
  .btn-secondary{background:#64748b;color:#fff}.btn-secondary:hover{background:#475569}
  .btn-danger{background:#dc2626;color:#fff}.btn-danger:hover{background:#b91c1c}

  /* ===== Modes ===== */
  .mode-selection-screen,.setup-screen,.results-screen,.game-screen{text-align:center}
  .mode-options{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:14px;max-width:860px;margin:14px auto 0}
  .mode-card{background:#fff;border:2px solid #e5e7eb;border-radius:14px;padding:18px;cursor:pointer;transition:.22s;text-align:left}
  .mode-card:hover{border-color:#2563eb;box-shadow:0 8px 22px -12px rgba(2,6,23,.25);transform:translateY(-2px)}
  .mode-card.selected{border-color:#2563eb;background:#eff6ff}
  .mode-card h3{margin:0 0 6px 0;font-size:18px}
  .mode-card p{margin:0;color:#6b7280;font-size:13px;line-height:1.5}

  /* ===== Setup ===== */
  .setup-controls{max-width:540px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
  .control-group{text-align:left}
  .control-group label{display:block;margin-bottom:6px;font-size:13px;color:#334155}
  .control-group input[type="range"]{width:100%}

  /* ===== Game Layouts ===== */
  .game-layout{display:flex;align-items:center;justify-content:center;gap:28px;min-height:520px}
  .side-control{display:flex;flex-direction:column;gap:10px;align-items:center}
  .build{font-size:13px;color:#475569;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:8px 10px}

  /* ===== Spatial Grid ===== */
  .spatial-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:#cbd5e1;border:2px solid #94a3b8;border-radius:12px;overflow:hidden}
  .grid-cell{width:120px;height:120px;background:#f8fafc;display:flex;align-items:center;justify-content:center;transition:.18s}
  .grid-cell.active{background:#3b82f6;color:#fff}

  /* ===== Premise Box ===== */
  .premise-box{background:#1d4ed8;border:2px solid #1e40af;border-radius:14px;padding:14px;min-height:240px;width:720px;color:#fff;display:flex;align-items:center;justify-content:center}
  .premise-text{font-size:20px;font-weight:600;line-height:1.35;display:flex;flex-direction:column;gap:8px}

  /* ===== Voice N‚ÄëMatch ===== */
  .voice{--bg:#0b0d10;--fg:#e6fbff;--a:#00ccff;--mut:#8fe7ff;background:var(--bg);color:var(--fg);border-radius:14px;padding:14px;text-align:left}
  .voice-row{display:flex;gap:12px;flex-wrap:wrap}
  .voice-col{flex:1 1 340px}
  .vbox{background:#101418;border:1px solid rgba(0,200,255,.25);border-radius:14px;padding:12px}
  .vtitle{font-weight:800;margin-bottom:6px;letter-spacing:.3px}
  .vmut{color:var(--mut);font-size:12px}
  .vsel,.vrange,.vnum{width:100%;min-height:38px}
  .vbtn{background:#0b0d10;color:var(--a);border:1px solid var(--a);border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .vkbd{border:1px solid rgba(255,255,255,.25);padding:2px 6px;border-radius:6px;background:#0b0d10}
  #vpremise{margin-top:12px;min-height:96px;background:#0d1317;border:1px solid rgba(0,200,255,.25);border-radius:12px;padding:10px;font-size:18px;line-height:1.55}
  #vpremise .rel{padding:0 6px;border-radius:6px}
  #vpremise .rel.active{background:rgba(0,200,255,.2);outline:1px solid rgba(0,200,255,.45)}

  /* ===== Results ===== */
  .results-panel{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:14px;max-width:560px;margin:0 auto;text-align:left;font-size:14px}

  /* ===== Responsive ===== */
  @media (max-width:900px){ .premise-box{width:96vw} .grid-cell{width:96px;height:96px} }
  @media (max-width:640px){ .mode-options{grid-template-columns:1fr} .grid-cell{width:82px;height:82px} }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <div class="title"><span style="font-size:28px">üß†</span><h1>Relational‚ÄëSpatial Dual N‚ÄëBack</h1></div>
      <div class="header-right">
        <div id="scoreDisplay" class="score-display hidden"></div>
        <div id="settingsDisplay" class="settings-display hidden"></div>
      </div>
    </div>

    <!-- MODE SELECTION -->
    <div id="modeSelectionScreen" class="mode-selection-screen">
      <h2 style="margin:0 0 12px 0">Choose Your Game Mode</h2>
      <div class="mode-options">
        <div class="mode-card" data-mode="ultra"><h3>Ultra‚ÄëN‚ÄëRelational‚ÄëReasoning</h3><p>Modal logic with temporal indices and algebraic operators.</p></div>
        <div class="mode-card" data-mode="advanced"><h3>Advanced‚ÄëN‚ÄëRelational‚ÄëReasoning</h3><p>Generators, mappings & computational relations.</p></div>
        <div class="mode-card" data-mode="relational"><h3>Relational N‚ÄëBack</h3><p>Compatibility of spatial statements across trials.</p></div>
        <div class="mode-card" data-mode="spatial"><h3>Spatial N‚ÄëBack</h3><p>Classic 3√ó3 grid. Space to mark a match.</p></div>
        <div class="mode-card" data-mode="dual"><h3>Dual N‚ÄëBack</h3><p>Spatial + Relational simultaneously (Space/Enter).</p></div>
        <div class="mode-card" data-mode="voice"><h3>Voice N‚ÄëMatch</h3><p>Logic‚Äëonly N‚Äëmatch with <b>spoken</b> premises; full region + female voice chooser.</p></div>
      </div>
      <button id="continueToSetup" class="btn btn-primary" style="margin-top:14px" disabled>Continue to Setup ‚Üí</button>
    </div>

    <!-- SETUP -->
    <div id="setupScreen" class="setup-screen hidden">
      <div id="setupContent"></div>
      <button id="startGameBtn" class="btn btn-primary" style="margin-top:12px">‚ñ∂ Start Game</button>
      <button id="backToModeBtn" class="btn btn-secondary" style="margin-top:12px;margin-left:8px">‚Üê Back</button>
    </div>

    <!-- RESULTS -->
    <div id="resultsScreen" class="results-screen hidden">
      <h2 style="color:#16a34a;margin:0 0 10px 0">Session Complete!</h2>
      <div class="results-panel"><div id="finalScores"></div></div>
      <div style="margin-top:12px">
        <button id="newSessionBtn" class="btn btn-primary">üîÑ New Session</button>
        <button id="changeModeBtn" class="btn btn-secondary" style="margin-left:8px">‚Üê Change Mode</button>
      </div>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="game-screen hidden">
      <div id="gameContent"></div>
      <div class="controls" style="margin-top:10px">
        <button id="pauseBtn" class="btn btn-secondary">‚è∏ Pause</button>
        <button id="resetBtn" class="btn btn-danger">üîÑ Reset</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
const rnd = (n)=>Math.floor(Math.random()*n);
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=rnd(i+1);[a[i],a[j]]=[a[j],a[i]]}return a}

/* ===== Global State ===== */
let gameState='modeSelection', selectedMode=null;
let nBackLevel=2, premisesCount=3, maxTrials=80, trialSpeed=3800;
let currentTrial=0, positionHistory=[], premisesHistory=[], currentPosition=null, currentPremises=null;
let isPlaying=false, awaitingResponse=false, spatialResponseGiven=false, relationalResponseGiven=false, trialTimeout=null;
let spatialScore={correct:0,total:0,actualMatches:0,missedMatches:0};
let relationalScore={correct:0,total:0,actualMatches:0,missedMatches:0};

/* ===== Data ===== */
const ENTITY_NAMES=['KIR','LUM','ZUN','NAT','DAW','RIB','PUG','NUZ','QIC','NOL','XEN','TIQ','BIM','DAN','LAR','NEZ','VEN','ZEQ','FOW','KAP'];
const REL_TYPES=[
 'one step North','one step South','one step East','one step West',
 'two steps North','two steps South','two steps East','two steps West',
 'one level above','one level below','two levels above','two levels below','on the same level',
 'one diagonal Northeast','one diagonal Northwest','one diagonal Southeast','one diagonal Southwest'
];

/* ===== Mode Selection ===== */
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('.mode-card').forEach(card=>{
    card.addEventListener('click',()=>{
      document.querySelectorAll('.mode-card').forEach(c=>c.classList.remove('selected'));
      card.classList.add('selected'); selectedMode=card.dataset.mode; $('continueToSetup').disabled=false;
    });
  });
  $('continueToSetup').onclick=showSetup;
  $('backToModeBtn').onclick=()=>{$('setupScreen').classList.add('hidden');$('modeSelectionScreen').classList.remove('hidden');$('continueToSetup').disabled=true;selectedMode=null;};
  $('startGameBtn').onclick=startGame;
  // prevent Space scrolling
  window.addEventListener('keydown', e=>{ if(isPlaying && (e.code==='Space' || e.key===' ')) e.preventDefault(); });
});

function showSetup(){ $('modeSelectionScreen').classList.add('hidden'); $('setupScreen').classList.remove('hidden'); gameState='setup'; renderSetup(); }

function renderSetup(){
  const el=$('setupContent');
  const labelMap={ultra:'Ultra‚ÄëN‚ÄëRelational‚ÄëReasoning',advanced:'Advanced‚ÄëN‚ÄëRelational‚ÄëReasoning',relational:'Relational N‚ÄëBack',spatial:'Spatial N‚ÄëBack',dual:'Dual N‚ÄëBack',voice:'Voice N‚ÄëMatch'};
  const extra=['relational','advanced','ultra','dual'].includes(selectedMode) ?
  `<div class="control-group"><label>Statements per Trial: <b id="premisesValue">${premisesCount}</b></label><input id="premisesCount" type="range" min="1" max="4" value="${premisesCount}"></div>` : '';
  el.innerHTML = `
    <h3 style="margin:0 0 10px 0">${labelMap[selectedMode]||'Setup'} ‚Äî Setup</h3>
    <div class="setup-controls">
      <div class="control-group"><label>N‚ÄëBack Level: <b id="nBackValue">${nBackLevel}</b></label><input id="nBackLevel" type="range" min="1" max="12" value="${nBackLevel}"></div>
      ${extra}
      <div class="control-group"><label>Session Length: <b id="maxTrialsValue">${maxTrials}</b> trials</label><input id="maxTrials" type="range" min="30" max="240" step="10" value="${maxTrials}"></div>
      <div class="control-group"><label>Trial Duration: <b id="trialSpeedValue">${(trialSpeed/1000).toFixed(1)}</b>s</label><input id="trialSpeed" type="range" min="2500" max="8000" step="250" value="${trialSpeed}"></div>
    </div>`;
  $('nBackLevel').oninput=e=>{ nBackLevel=+e.target.value; $('nBackValue').textContent=nBackLevel; };
  const pc=$('premisesCount'); if(pc) pc.oninput=e=>{ premisesCount=+e.target.value; $('premisesValue').textContent=premisesCount; };
  $('maxTrials').oninput=e=>{ maxTrials=+e.target.value; $('maxTrialsValue').textContent=maxTrials; };
  $('trialSpeed').oninput=e=>{ trialSpeed=+e.target.value; $('trialSpeedValue').textContent=(trialSpeed/1000).toFixed(1); };
}

/* ===== Game Render ===== */
function startGame(){
  isPlaying=true; currentTrial=0; positionHistory.length=0; premisesHistory.length=0;
  spatialScore={correct:0,total:0,actualMatches:0,missedMatches:0};
  relationalScore={correct:0,total:0,actualMatches:0,missedMatches:0};
  spatialResponseGiven=false; relationalResponseGiven=false;
  $('setupScreen').classList.add('hidden'); $('gameScreen').classList.remove('hidden');
  renderGameScreen(); updateSettingsPanel();
  if(selectedMode==='voice'){ initVoiceUI(); return; }
  setTimeout(()=>startNewTrial(),650);
}

function renderGameScreen(){
  const g=$('gameContent');
  if(selectedMode==='dual'){
    g.innerHTML=`
      <div class="game-layout">
        <div class="side-control"><button id="spatialMatchBtn" class="btn btn-secondary">Spatial (Space)</button><div id="spatialFeedback" class="build hidden">...</div></div>
        <div class="grid-container"><div id="spatialGrid" class="spatial-grid"></div></div>
        <div class="side-control"><button id="relationalMatchBtn" class="btn btn-primary">Relational (Enter)</button><div id="relationalFeedback" class="build hidden">...</div></div>
      </div>`; createGrid('spatialGrid');
  } else if(selectedMode==='spatial'){
    g.innerHTML=`
      <div class="game-layout">
        <div class="side-control"><button id="spatialOnlyBtn" class="btn btn-secondary">Match (Space)</button></div>
        <div class="grid-container"><div id="spatialOnlyGrid" class="spatial-grid"></div></div>
      </div>`; createGrid('spatialOnlyGrid');
  } else if(['relational','advanced','ultra'].includes(selectedMode)){
    g.innerHTML=`
      <div class="game-layout">
        <div class="side-control"><button id="relationalOnlyBtn" class="btn btn-primary">Match (Enter)</button></div>
        <div class="grid-container"><div class="premise-box"><div id="premiseDisplay" class="premise-text"></div></div></div>
      </div>`;
  } else if(selectedMode==='voice'){
    g.innerHTML = voiceHTML();
  }
  bindGameEvents();
}

function createGrid(id){ const grid=$(id); grid.innerHTML=''; for(let i=0;i<9;i++){ const d=document.createElement('div'); d.className='grid-cell'; d.id=`${id}-c${i}`; grid.appendChild(d);} }

function bindGameEvents(){
  $('pauseBtn').onclick=togglePause; $('resetBtn').onclick=resetGame;
  document.onkeydown=(e)=>{
    if(gameState!=='playing'||!awaitingResponse||currentTrial<=nBackLevel) return;
    if((selectedMode==='spatial'||selectedMode==='dual')&&e.code==='Space'&&!spatialResponseGiven){ e.preventDefault(); handleSpatialResponse(true); }
    if((['relational','advanced','ultra','dual'].includes(selectedMode))&&e.code==='Enter'&&!relationalResponseGiven){ e.preventDefault(); handleRelationalResponse(true); }
  };
  const sm=$('spatialMatchBtn'); if(sm) sm.onclick=()=>!spatialResponseGiven&&handleSpatialResponse(true);
  const so=$('spatialOnlyBtn'); if(so) so.onclick=()=>!spatialResponseGiven&&handleSpatialResponse(true);
  const rm=$('relationalMatchBtn'); if(rm) rm.onclick=()=>!relationalResponseGiven&&handleRelationalResponse(true);
  const ro=$('relationalOnlyBtn'); if(ro) ro.onclick=()=>!relationalResponseGiven&&handleRelationalResponse(true);
  if(selectedMode==='voice') attachVoiceHandlers();
}

function updateSettingsPanel(){
  const names={ultra:'Ultra‚ÄëRelational',advanced:'Advanced‚ÄëRelational',relational:'Relational',spatial:'Spatial',dual:'Dual',voice:'Voice N‚ÄëMatch'};
  let html=`<div><b>Mode:</b> ${names[selectedMode]||'‚Äî'}</div>
            <div><b>N‚ÄëBack:</b> ${nBackLevel}</div>
            <div><b>Session:</b> ${maxTrials} trials</div>
            <div><b>Trial:</b> ${(trialSpeed/1000).toFixed(1)}s</div>`;
  if(['relational','advanced','ultra','dual'].includes(selectedMode)){ html+=`<div><b>Statements/Trial:</b> ${premisesCount}</div>`; }
  $('settingsDisplay').innerHTML=html; $('settingsDisplay').classList.remove('hidden');
}

/* ===== Generation / Compatibility ===== */
function generateRandomPosition(){ return rnd(9); }
function generatePremises(){
  const ents=[]; while(ents.length<premisesCount+2){ const e=ENTITY_NAMES[rnd(ENTITY_NAMES.length)]; if(!ents.includes(e)) ents.push(e); }
  const out=[]; for(let i=0;i<premisesCount;i++){ out.push(`${ents[i]} is ${REL_TYPES[rnd(REL_TYPES.length)]} of ${ents[i+1]}`); } return out;
}
function checkPremisesCompatibility(a,b){
  const parse = arr => arr.map(s=>{const m=s.match(/(\w+)\s+is\s+(.*?)\s+of\s+(\w+)/);return m?{u:m[1],r:m[2],v:m[3]}:null}).filter(Boolean);
  const inv={'one step North':'one step South','one step South':'one step North','one step East':'one step West','one step West':'one step East','one level above':'one level below','one level below':'one level above','two levels above':'two levels below','two levels below':'two levels above'};
  const A=parse(a),B=parse(b); let ok=0,need=Math.ceil(Math.min(A.length,B.length)/2);
  for(const x of A){ if(B.some(y=> (x.u===y.u && x.v===y.v) && (x.r===y.r || inv[x.r]===y.r))) ok++; }
  return ok>=need;
}

/* ===== Game Loop ===== */
function startNewTrial(){
  if(currentTrial>=maxTrials){ endSession(); return; }
  const pos=generateRandomPosition(), prem=generatePremises();
  if(selectedMode==='spatial'||selectedMode==='dual'){ currentPosition=pos; positionHistory.push(pos); }
  if(['relational','advanced','ultra','dual'].includes(selectedMode)){ currentPremises=prem; premisesHistory.push(prem); }
  currentTrial++; spatialResponseGiven=false; relationalResponseGiven=false; awaitingResponse=true;

  if(currentTrial>nBackLevel){
    if(selectedMode==='spatial'||selectedMode==='dual'){ const match = positionHistory[currentTrial-nBackLevel-1]===currentPosition; if(match) spatialScore.actualMatches++; }
    if(['relational','advanced','ultra','dual'].includes(selectedMode)){ const nb=premisesHistory[currentTrial-nBackLevel-1]; if(nb && checkPremisesCompatibility(currentPremises,nb)) relationalScore.actualMatches++; }
  }

  showTrial();
  trialTimeout=setTimeout(()=>{ clearTrial(); setTimeout(()=>{ if(isPlaying) startNewTrial(); }, 630); }, Math.max(1200, trialSpeed-900));
}

function showTrial(){
  if(selectedMode==='dual'){
    document.querySelectorAll('#spatialGrid .grid-cell').forEach(c=>c.classList.remove('active'));
    const ac=$('spatialGrid-c'+currentPosition); if(ac) ac.classList.add('active');
    const p=$('premiseDisplay'); if(p) p.innerHTML=currentPremises.map(x=>`<div>${x}</div>`).join('');
  } else if(selectedMode==='spatial'){
    document.querySelectorAll('#spatialOnlyGrid .grid-cell').forEach(c=>c.classList.remove('active'));
    const ac=$('spatialOnlyGrid-c'+currentPosition); if(ac) ac.classList.add('active');
  } else if(['relational','advanced','ultra'].includes(selectedMode)){
    const p=$('premiseDisplay'); if(p) p.innerHTML=currentPremises.map(x=>`<div>${x}</div>`).join('');
  }
  // score strip
  const lines=[`<b>Trial:</b> ${currentTrial}/${maxTrials}`];
  if(selectedMode==='spatial'||selectedMode==='dual'){ const acc=spatialScore.total?(100*spatialScore.correct/spatialScore.total).toFixed(1):'0.0'; lines.push(`<b>Spatial:</b> ${spatialScore.correct}/${spatialScore.total} (${acc}%)`); }
  if(['relational','advanced','ultra','dual'].includes(selectedMode)){ const acc=relationalScore.total?(100*relationalScore.correct/relationalScore.total).toFixed(1):'0.0'; lines.push(`<b>Relational:</b> ${relationalScore.correct}/${relationalScore.total} (${acc}%)`); }
  $('scoreDisplay').innerHTML=lines.join(' ‚Ä¢ '); $('scoreDisplay').classList.remove('hidden');
}
function clearTrial(){
  awaitingResponse=false;
  if(selectedMode==='dual'){ const p=$('premiseDisplay'); if(p) p.innerHTML=''; document.querySelectorAll('#spatialGrid .grid-cell').forEach(c=>c.classList.remove('active')); }
  if(selectedMode==='spatial'){ document.querySelectorAll('#spatialOnlyGrid .grid-cell').forEach(c=>c.classList.remove('active')); }
  if(['relational','advanced','ultra'].includes(selectedMode)){ const p=$('premiseDisplay'); if(p) p.innerHTML=''; }
}
function handleSpatialResponse(isMatch){
  if(!awaitingResponse||currentTrial<=nBackLevel||spatialResponseGiven) return; spatialResponseGiven=true;
  const nb=positionHistory[currentTrial-nBackLevel-1], actual=(nb===currentPosition);
  if(actual && !isMatch) spatialScore.missedMatches++; spatialScore.correct += (isMatch===actual)?1:0; spatialScore.total++;
}
function handleRelationalResponse(isCompatible){
  if(!awaitingResponse||currentTrial<=nBackLevel||relationalResponseGiven) return; relationalResponseGiven=true;
  const nb=premisesHistory[currentTrial-nBackLevel-1], actual=(nb && checkPremisesCompatibility(currentPremises,nb));
  if(actual && !isCompatible) relationalScore.missedMatches++; relationalScore.correct += (isCompatible===actual)?1:0; relationalScore.total++;
}
function togglePause(){ const btn=$('pauseBtn'); if(isPlaying){ isPlaying=false; btn.textContent='‚ñ∂ Resume'; clearTimeout(trialTimeout); } else { isPlaying=true; btn.textContent='‚è∏ Pause'; if(selectedMode!=='voice') startNewTrial(); else voice.resumeAfterPause(); } }
function resetGame(){ isPlaying=false; clearTimeout(trialTimeout); $('gameScreen').classList.add('hidden'); $('setupScreen').classList.remove('hidden'); }
function endSession(){
  isPlaying=false; clearTimeout(trialTimeout); $('gameScreen').classList.add('hidden'); $('resultsScreen').classList.remove('hidden');
  let html=''; if(selectedMode==='spatial'||selectedMode==='dual'){ const acc=spatialScore.total?Math.round(100*spatialScore.correct/spatialScore.total):0; html+=`<div><b>Spatial:</b> ${spatialScore.correct}/${spatialScore.total} (${acc}%) ‚Äî matches ${spatialScore.actualMatches}, missed ${spatialScore.missedMatches}</div>`; }
  if(['relational','advanced','ultra','dual'].includes(selectedMode)){ const acc=relationalScore.total?Math.round(100*relationalScore.correct/relationalScore.total):0; html+=`<div><b>Relational:</b> ${relationalScore.correct}/${relationalScore.total} (${acc}%) ‚Äî matches ${relationalScore.actualMatches}, missed ${relationalScore.missedMatches}</div>`; }
  $('finalScores').innerHTML=html||'<em>No scores</em>';
  $('newSessionBtn').onclick=()=>{ $('resultsScreen').classList.add('hidden'); $('setupScreen').classList.remove('hidden'); };
  $('changeModeBtn').onclick=()=>{ $('resultsScreen').classList.add('hidden'); $('modeSelectionScreen').classList.remove('hidden'); $('continueToSetup').disabled=true; selectedMode=null; };
}

/* ===== Voice N‚ÄëMatch ===== */
function voiceHTML(){ return `
<div class="voice">
  <div class="voice-row">
    <div class="voice-col"><div class="vbox">
      <div class="vtitle">Timing & Complexity</div>
      <label class="vmut">N‚Äëback: <b id="vnVal">1</b></label><input id="vn" class="vrange" type="range" min="1" max="12" value="1"/>
      <label class="vmut">Trials: <b id="vtVal">40</b></label><input id="vtrials" class="vrange" type="range" min="10" max="240" step="5" value="40"/>
      <label class="vmut">Pause between relations (s): <b id="vpVal">1.0</b></label><input id="vpause" class="vrange" type="range" min="0" max="5" step="0.1" value="1"/>
      <label class="vmut">Pause between premises (s): <b id="vpiVal">1.0</b></label><input id="vpremiseInterval" class="vrange" type="range" min="0" max="5" step="0.1" value="1"/>
      <label class="vmut">Target match rate: <b id="vrVal">25%</b></label><input id="vrate" class="vrange" type="range" min="0" max="100" step="1" value="25"/>
      <label class="vmut">Relations per premise: <b id="vrcVal">2</b></label><input id="vrelCount" class="vnum" type="number" min="1" max="4" value="2"/>
    </div></div>

    <div class="voice-col"><div class="vbox">
      <div class="vtitle">Voice</div>
      <label class="vmut">Region</label><select id="regionSelect" class="vsel"></select>
      <label class="vmut">Female voice</label><select id="voice" class="vsel"></select>
      <div class="vmut" style="margin-top:6px">Menus fill instantly; they auto‚Äëupdate when the browser exposes new voices.</div>
      <label class="vmut" style="margin-top:6px">Rate: <b id="rateVal">0.95</b></label><input id="vRate" class="vrange" type="range" min="0.7" max="1.6" step="0.01" value="0.95"/>
      <label class="vmut">Pitch: <b id="pitchVal">1.25</b></label><input id="vPitch" class="vrange" type="range" min="0.7" max="2" step="0.01" value="1.25"/>
      <label class="vmut">Volume: <b id="vVolVal">1.00</b></label><input id="vVol" class="vrange" type="range" min="0" max="1" step="0.05" value="1.0"/>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"><button id="testVoice" class="vbtn" type="button">Test voice</button><button id="refreshVoices" class="vbtn" type="button">Refresh</button></div>
    </div></div>

    <div class="voice-col"><div class="vbox">
      <div class="vtitle">Controls / Status</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
        <button id="vstart" class="vbtn">‚ñ∂ Start</button>
        <button id="vpauseBtn" class="vbtn" disabled>‚è∏ Pause</button>
        <button id="vreset" class="vbtn" disabled>üîÑ Reset</button>
        <button id="vhit" class="vbtn" disabled>‚úì Match <span class="vkbd">Space</span></button>
        <button id="vskip" class="vbtn" disabled>‚è≠ Skip</button>
      </div>
      <div class="vmut" style="margin-top:8px">Trial <b id="vidx">0</b>/<b id="vmax">40</b> ‚Ä¢ Planned: <b id="vplan">‚Äî</b></div>
      <div class="vmut">Correct: <b id="vcorr">0</b> ‚Ä¢ Errors: <b id="verr">0</b></div>
    </div></div>
  </div>
  <div class="vbox" style="margin-top:12px"><div class="vtitle">Premise (spoken + visual)</div><div id="vpremise" aria-live="polite">‚Äî</div></div>
</div>`; }

const voice = {
  N:1, MAX:40, REL_COUNT:2, TARGET_RATE:25, PAUSE_SEC:1.0, PREMISE_INTERVAL_SEC:1.0,
  idx:0, running:false, paused:false, waitTimer:null, planned:[], history:[], correct:0, errors:0,
  voiceObj:null, rate:0.95, pitch:1.25, volume:1.0,
  FEMALE:/\b(zira|samantha|karen|moira|tessa|serena|victoria|joanna|jenny|aria|ivy|nicole|salli|olivia|ella|ava|amy|emma|mia|sophia|isabella|grace|zoe|chloe|sarah|sofia|lily|lucy|hazel|hannah|noor|layla)\b/i,
  REGIONS:['Australia','United Kingdom','United States','Canada','Ireland','New Zealand','South Africa','India','Other Region'],
  REGION_MAP:{AU:'Australia',GB:'United Kingdom',UK:'United Kingdom',US:'United States',CA:'Canada',IE:'Ireland',NZ:'New Zealand',ZA:'South Africa',IN:'India'},
  regionName(lang){ const m=String(lang).match(/^[a-z]{2,3}[-_]?([A-Z]{2})/); return this.REGION_MAP[m?.[1]] || 'Other Region' },
  voicesNow(){ try{return speechSynthesis.getVoices()||[]}catch(_){return[]} },
  vKey(v){ return v.voiceURI || (v.name+'|'+v.lang) },

  populateMenusFast(){
    const regionSel=$('regionSelect'), voiceSel=$('voice'); if(!regionSel||!voiceSel) return;
    regionSel.innerHTML = this.REGIONS.map(r=>`<option value="${r}">${r}</option>`).join(''); regionSel.value='Australia';
    const raw=this.voicesNow();
    const female = raw.filter(v => this.FEMALE.test((v.name+' '+v.voiceURI).toLowerCase()) || /female/i.test(v.name));
    const use = female.length? female : raw;
    const byRegion = r => use.filter(v => this.regionName(v.lang)===r);
    const fill = region => {
      voiceSel.innerHTML='';
      const pack = byRegion(region); const list = pack.length? pack: use;
      list.forEach(v=>{ const o=document.createElement('option'); o.value=this.vKey(v); o.textContent=`${v.name} ‚Äî ${this.regionName(v.lang)}`; o.title=`${v.voiceURI} ‚Äî ${v.lang}`; voiceSel.appendChild(o); });
      this.voiceObj = list[0] || null;
    };
    fill(regionSel.value);
    regionSel.onchange=()=>fill(regionSel.value);
    voiceSel.onchange=()=>{ const key=voiceSel.value; const found=this.voicesNow().find(v=> this.vKey(v)===key); if(found) this.voiceObj=found; };
    if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged = ()=> this.populateMenusFast(); }
  },

  say(text){
    return new Promise(res=>{
      if(!('speechSynthesis' in window)) return res();
      try{ speechSynthesis.cancel(); }catch(_){}
      const u=new SpeechSynthesisUtterance(text);
      if(this.voiceObj) u.voice=this.voiceObj;
      u.lang=(this.voiceObj && this.voiceObj.lang) || 'en-AU';
      u.rate=this.rate; u.pitch=this.pitch; u.volume=this.volume;
      u.onend=()=>res(); u.onerror=()=>res();
      try{ speechSynthesis.speak(u); setTimeout(res,7000); }catch(_){ res(); }
    });
  },

  token(){ const L='ABCDEFGHIJKLMNOPQRSTUVWXYZ'; return L[rnd(26)]+(1+rnd(9)); },
  uniq(n){ const s=new Set(); while(s.size<n) s.add(this.token()); return [...s]; },
  clause(a,rel,b){ return `${a} is ${rel} of ${b}`; },
  rel(){ const H=['north','south','east','west','northeast','northwest','southeast','southwest']; const pick=()=>H[rnd(H.length)];
         let parts=[pick()]; if(rnd(10)<3) parts.push(rnd(2)?'one level above':'one level below'); return parts.join(' and '); },
  premise(){ const t=this.uniq(3); const clauses=[]; for(let i=0;i<this.REL_COUNT;i++){ clauses.push(this.clause(t[i%t.length], this.rel(), t[(i+1)%t.length])); } return clauses.join(' and '); },
  parse(s){ const edges=[],nodes=new Set(); String(s).split(/\s+and\s+/i).map(p=>p.trim()).forEach(p=>{ const m=p.match(/^([A-Z]\d+)\s+is\s+(.+?)\s+of\s+([A-Z]\d+)$/i); if(m){edges.push({u:m[1],r:m[2],v:m[3]});nodes.add(m[1]);nodes.add(m[3]);}}); return {nodes:[...nodes],edges}; },
  match(a,b){ const A=this.parse(a),B=this.parse(b); for(const n of A.nodes){ if(!B.nodes.includes(n)) return false } return A.edges.some(e => B.edges.some(f=> e.u===f.u && e.v===f.v)); },

  verbalizeClause(c){ return c.replace(/([A-Z])(\d+)/g,(_,L,D)=> `${L} ${D.split('').join(' ')}`); },
  showAndSpeak(sentence){
    const parts = sentence.split(/\s+and\s+/i).map(p=>this.verbalizeClause(p));
    const box=$('vpremise'); box.innerHTML='';
    parts.forEach((p,i)=>{ const sp=document.createElement('span'); sp.className='rel'; sp.textContent=p; box.appendChild(sp); if(i<parts.length-1){ const sep=document.createElement('span'); sep.textContent=' and '; box.appendChild(sep); } });
    return (async()=>{
      for(let i=0;i<parts.length;i++){ box.querySelectorAll('.rel').forEach((n,idx)=>n.classList.toggle('active',idx===i)); await this.say(parts[i]+'.'); if(i<parts.length-1){ await new Promise(r=>{ this.waitTimer=setTimeout(()=>{ this.waitTimer=null; r(); }, this.PAUSE_SEC*1000); }); } }
      await new Promise(r=>{ this.waitTimer=setTimeout(()=>{ this.waitTimer=null; r(); }, this.PREMISE_INTERVAL_SEC*1000); });
    })();
  },

  plan(){ this.planned.length=0; for(let i=0;i<this.MAX;i++) this.planned.push(false); const elig=[]; for(let i=this.N;i<this.MAX;i++) elig.push(i); shuffle(elig); const k=Math.round((this.TARGET_RATE/100)*elig.length); for(let i=0;i<k;i++) this.planned[elig[i]]=true; },
  matching(prev){ const P=this.parse(prev); if(!P.edges.length) return prev; return P.edges.map(e=> this.clause(e.u,e.r,e.v)).join(' and '); },

  async run(){
    if(!this.running||this.paused) return;
    if(this.idx>=this.MAX){ this.stop(); return; }
    const s=(this.idx>=this.N && this.planned[this.idx])? this.matching(this.history[this.idx-this.N]) : this.premise();
    this.history[this.idx]=s; $('vidx').textContent=this.idx; $('vplan').textContent=(this.idx>=this.N && this.planned[this.idx])?'MATCH':'NON‚Äëmatch';
    await this.showAndSpeak(s); this.idx++; this.run();
  },

  start(){ if(this.running) return; this.running=true; this.paused=false; this.idx=0; this.correct=0; this.errors=0; this.history.length=0; this.plan();
           $('vpauseBtn').disabled=false; $('vreset').disabled=false; $('vhit').disabled=false; $('vskip').disabled=false; $('vmax').textContent=this.MAX; this.run(); },
  stop(){ this.running=false; this.paused=false; clearTimeout(this.waitTimer); try{speechSynthesis.cancel()}catch(_){}
         $('vpauseBtn').disabled=true; $('vhit').disabled=true; $('vskip').disabled=true; },
  togglePause(){ if(!this.running&&!this.paused) return; if(!this.paused){ this.paused=true; clearTimeout(this.waitTimer); try{speechSynthesis.cancel()}catch(_){} $('vpauseBtn').textContent='‚ñ∂ Resume'; } else { this.paused=false; $('vpauseBtn').textContent='‚è∏ Pause'; this.run(); } },
  reset(){ this.stop(); this.idx=0; this.correct=0; this.errors=0; $('vpremise').textContent='‚Äî'; $('vidx').textContent='0'; $('vcorr').textContent='0'; $('verr').textContent='0'; },
  resumeAfterPause(){ if(selectedMode==='voice' && this.running) this.run(); },
  hit(){ const actual=(this.idx>=this.N)&&this.match(this.history[this.idx-this.N],this.history[this.idx]||''); if(actual) this.correct++; else this.errors++; $('vcorr').textContent=this.correct; $('verr').textContent=this.errors; },
  skip(){ clearTimeout(this.waitTimer); try{speechSynthesis.cancel()}catch(_){} this.idx++; this.run(); },
  testVoice(){ const u=new SpeechSynthesisUtterance('Voice check. C three is northeast of H seven.'); if(this.voiceObj) u.voice=this.voiceObj; u.rate=this.rate; u.pitch=this.pitch; u.volume=this.volume; try{speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(_){} }
};

function initVoiceUI(){ voice.populateMenusFast(); }
function attachVoiceHandlers(){
  $('vn').oninput=e=>{ voice.N=+e.target.value; $('vnVal').textContent=voice.N; };
  $('vtrials').oninput=e=>{ voice.MAX=+e.target.value; $('vtVal').textContent=voice.MAX; $('vmax').textContent=voice.MAX; };
  $('vpause').oninput=e=>{ voice.PAUSE_SEC=+e.target.value; $('vpVal').textContent=e.target.value; };
  $('vpremiseInterval').oninput=e=>{ voice.PREMISE_INTERVAL_SEC=+e.target.value; $('vpiVal').textContent=e.target.value; };
  $('vrate').oninput=e=>{ voice.TARGET_RATE=+e.target.value; $('vrVal').textContent=e.target.value+'%'; };
  $('vrelCount').oninput=e=>{ voice.REL_COUNT=Math.max(1,+e.target.value); $('vrcVal').textContent=voice.REL_COUNT; };

  $('vRate').oninput=e=>{ voice.rate=+e.target.value; $('rateVal').textContent=e.target.value; };
  $('vPitch').oninput=e=>{ voice.pitch=+e.target.value; $('pitchVal').textContent=e.target.value; };
  $('vVol').oninput=e=>{ voice.volume=+e.target.value; $('vVolVal').textContent=(+e.target.value).toFixed(2); };

  $('vstart').onclick=()=>voice.start();
  $('vpauseBtn').onclick=()=>voice.togglePause();
  $('vreset').onclick=()=>voice.reset();
  $('vhit').onclick=()=>voice.hit();
  $('vskip').onclick=()=>voice.skip();

  $('testVoice').onclick=()=>voice.testVoice();
  $('refreshVoices').onclick=()=>voice.populateMenusFast();
}
</script>
</body>
</html>
